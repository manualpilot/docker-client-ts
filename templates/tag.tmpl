import { Pool } from "undici";
import { Observable } from "rxjs";
import { z } from "zod";
import { sub } from "~/utils";
import { chunked } from "~/chunked";

{% for endpoint in endpoints %}

{% if endpoint.input_type %}
export const {{ endpoint.input_name }} = {{ endpoint.input_type }};
{% endif %}

{% if endpoint.output_type %}
export const {{ endpoint.output_name }} = {{ endpoint.output_type }};
{% endif %}

{% endfor %}

export default function {{ tag }}(pool: Pool) {
  return {
{% for endpoint in endpoints %}
    {{ endpoint.name }}: async (
    {% if endpoint.input_type %}
      input{% if endpoint.input_required %}?{% endif %}: z.infer<typeof {{ endpoint.input_name }}>,
    {% endif %}
    ): Promise<
    {% if endpoint.chunked %}
      Observable<string>
    {% elif endpoint.output_type %}
      z.infer<typeof {{ endpoint.output_name }}>
    {% else %}
      void
    {% endif %}
    > => {

    const resp = await pool.request({
      method: "{{ endpoint.method }}",
      {% if endpoint.path_has_params %}
      path: sub("{{ endpoint.path }}", input.path),
      {% else %}
      path: "{{ endpoint.path }}",
      {% endif %}
      {% if endpoint.input_has_query %}
      query: input{% if endpoint.input_required %}?{% endif %}.query,
      {% endif %}
      headers: {
        {% if endpoint.input_has_body %}
          "Content-Type": "application/json",
        {% endif %}
      },
      {% if endpoint.input_has_body %}
      body: JSON.stringify(input.body),
      {% endif %}
    });

    if (resp.statusCode >= 200 && resp.statusCode <= 299) {
      {% if endpoint.chunked %}
        return chunked(resp);
      {% elif endpoint.output_type %}
        return {{ endpoint.output_name }}.parse(await resp.body.json());
      {% else %}
        return;
      {% endif %}
    }

    // TODO: parse into the error types
    throw Error(await resp.body.text());
    },
{% endfor %}
  };
}
